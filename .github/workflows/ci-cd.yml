# ğŸ® Dawn of Stellar v4.1.0 - CI/CD Pipeline
# ì™„ì „ì²´ ë¡œê·¸ë¼ì´í¬ RPG + AI ì±„íŒ… ì‹œìŠ¤í…œ
name: "Dawn of Stellar v4.1.0 - CI/CD Pipeline"

on:
  push:
    branches: [ "master", "main", "dev" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  test:
    name: ğŸ§ª Test Game Systems
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: ğŸ” Lint with flake8
      run: |
        pip install flake8
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: ğŸ§ª Test Game Core
      run: |
        python -m pytest tests/ -v --cov=game/ --cov-report=xml || echo "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì¼ë¶€ ì‹¤íŒ¨"

    - name: ğŸ® Test Game Launch
      run: |
        timeout 10s python main.py --test || echo "ê²Œì„ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

    - name: ğŸ¤– Test AI Systems
      run: |
        python -c "from game.robat_personality_system import RobatPersonalitySystem; print('AI ì„±ê²© ì‹œìŠ¤í…œ OK')"
        python -c "from ai_language_model_integration import RealLanguageModelSystem; print('LLM ì—°ë™ ì‹œìŠ¤í…œ OK')"

  build-windows:
    name: ğŸªŸ Windows Build
    runs-on: windows-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: ğŸ”¨ Build Executable
      run: |
        pyinstaller --onefile --name "DawnOfStellar-v4.1.0" main.py

    - name: ğŸ“¤ Upload Windows Build
      uses: actions/upload-artifact@v3
      with:
        name: dawn-of-stellar-windows-v4.1.0
        path: dist/DawnOfStellar-v4.1.0.exe

  build-package:
    name: ğŸ“¦ Build Distribution Package
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: ğŸ“¦ Install Build Tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: ğŸ”¨ Build Package
      run: |
        python -m build

    - name: ğŸ“¤ Upload Package
      uses: actions/upload-artifact@v3
      with:
        name: dawn-of-stellar-package-v4.1.0
        path: dist/

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: ğŸ”’ Run Security Scan
      run: |
        pip install bandit safety
        bandit -r . -f json -o security-report.json || true
        safety check --json --output safety-report.json || true

    - name: ğŸ“¤ Upload Security Reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: "*-report.json"

  deploy:
    name: ğŸš€ Deploy Release
    runs-on: ubuntu-latest
    needs: [test, build-windows, build-package]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v3

    - name: ğŸš€ Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dawn-of-stellar-windows-v4.1.0/DawnOfStellar-v4.1.0.exe
          dawn-of-stellar-package-v4.1.0/*
        body: |
          # ğŸŒŸ Dawn of Stellar v4.1.0 Release ğŸŒŸ
          
          ## ğŸ”¥ ìƒˆë¡œìš´ ê¸°ëŠ¥
          - ğŸ‡°ğŸ‡· **EEVE-Korean AI ì±„íŒ…**: 27ê°œ ì§ì—…ë³„ í•œêµ­ì–´ ë¡œë°”íŠ¸ì™€ ëŒ€í™”
          - ğŸ¤– **Ollama ì—°ë™**: ë¡œì»¬ AI ëª¨ë¸ ì§€ì›
          - ğŸ’¬ **ì‹¤ì‹œê°„ ì±„íŒ…**: ê²Œì„ ì¤‘ AIì™€ ëŒ€í™”
          - ğŸ­ **27ê°œ ì§ì—…ë³„ ì„±ê²©**: ê°ê° ê³ ìœ í•œ ì„±ê²©ê³¼ ë§íˆ¬
          
          ## ğŸ“± ì§€ì› í”Œë«í¼
          - Windows 10/11 (64-bit)
          - Linux (Python 3.10+)
          - macOS (Python 3.10+)
          
          ## ğŸš€ ì„¤ì¹˜ ë°©ë²•
          1. DawnOfStellar-v4.1.0.exe ë‹¤ìš´ë¡œë“œ
          2. ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰
          3. ìë™ ì„¤ì¹˜ ì™„ë£Œ!
          
          ## ğŸ® ì£¼ìš” ê°œì„ ì‚¬í•­
          - AI ì±„íŒ… ì‹œìŠ¤í…œ ì™„ì „ êµ¬í˜„
          - í•œêµ­ì–´ ìµœì í™”
          - ì„±ëŠ¥ ê°œì„ 
          - ë²„ê·¸ ìˆ˜ì •
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: ğŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: [test, build-windows, build-package]
    if: always()

    steps:
    - name: ğŸ“¢ Success Notification
      if: ${{ needs.test.result == 'success' && needs.build-windows.result == 'success' }}
      run: |
        echo "ğŸ‰ Dawn of Stellar v4.1.0 ë¹Œë“œ ì„±ê³µ!"
        echo "âœ… í…ŒìŠ¤íŠ¸ í†µê³¼"
        echo "âœ… Windows ë¹Œë“œ ì™„ë£Œ"
        echo "âœ… íŒ¨í‚¤ì§€ ë¹Œë“œ ì™„ë£Œ"

    - name: âŒ Failure Notification
      if: ${{ needs.test.result == 'failure' || needs.build-windows.result == 'failure' }}
      run: |
        echo "âŒ Dawn of Stellar v4.1.0 ë¹Œë“œ ì‹¤íŒ¨"
        echo "ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
