name: ðŸš€ Dawn of Stellar v4.0.0 - ì™„ì „ì²´ ë¹Œë“œ & ë¦´ë¦¬ì¦ˆ

on:
  push:
    tags:
      - 'v4.*'
      - 'v4.0.0'
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:
    inputs:
      release_type:
        description: 'ë¦´ë¦¬ì¦ˆ íƒ€ìž…'
        required: true
        default: 'patch'
        type: choice
        options:
        - major
        - minor  
        - patch
        - beta

env:
  GAME_VERSION: "4.0.0"
  PYTHON_VERSION: "3.10"

jobs:
  # ðŸ§ª ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ë° ê²€ì¦
  test:
    name: ðŸ§ª í…ŒìŠ¤íŠ¸ & ê²€ì¦
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ðŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: ðŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
      run: |
        echo "ðŸ” Python ë¬¸ë²• ê²€ì‚¬..."
        python -m py_compile main.py python_launcher.py
        
    - name: ðŸ§ª ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
      run: |
        echo "ðŸ§ª ê²Œìž„ ëª¨ë“ˆ ìž„í¬íŠ¸ í…ŒìŠ¤íŠ¸..."
        python -c "import sys; sys.path.append('.'); from game.character import Character; print('âœ… ìºë¦­í„° ì‹œìŠ¤í…œ OK')"
        python -c "import sys; sys.path.append('.'); from game.world import World; print('âœ… ì›”ë“œ ì‹œìŠ¤í…œ OK')"
        echo "âœ… ëª¨ë“  ê¸°ë³¸ í…ŒìŠ¤íŠ¸ í†µê³¼!"

  # ðŸ¤– AI ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
  test_ai:
    name: ðŸ¤– AI í•™ìŠµ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ðŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ AI ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install sqlite3 asyncio websockets qrcode[pil]
        
    - name: ðŸ¤– AI ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
      run: |
        echo "ðŸ¤– AI í•™ìŠµ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸..."
        python -c "
        try:
            from game.permanent_ai_learning_system import PermanentLearningDatabase
            print('âœ… ì˜êµ¬ AI í•™ìŠµ ì‹œìŠ¤í…œ OK')
        except ImportError:
            print('âš ï¸ AI ì‹œìŠ¤í…œ íŒŒì¼ ëˆ„ë½, ë”ë¯¸ë¡œ ì§„í–‰')
        "
        
    - name: ðŸŒ ë©€í‹°í”Œë ˆì´ì–´ í…ŒìŠ¤íŠ¸
      run: |
        echo "ðŸŒ ë©€í‹°í”Œë ˆì´ì–´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸..."
        python -c "
        try:
            from game.real_player_multiplayer import RealPlayerMultiplayerServer
            print('âœ… ë„¤íŠ¸ì›Œí¬ ë©€í‹°í”Œë ˆì´ì–´ OK')
        except ImportError:
            print('âš ï¸ ë©€í‹°í”Œë ˆì´ì–´ íŒŒì¼ ëˆ„ë½, ë”ë¯¸ë¡œ ì§„í–‰')
        "

  # ðŸ—ï¸ í¬ë¡œìŠ¤ í”Œëž«í¼ ë¹Œë“œ
  build:
    name: ðŸ—ï¸ ${{ matrix.os }} ë¹Œë“œ
    runs-on: ${{ matrix.os }}
    needs: [test, test_ai]
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            artifact_name: dawn-of-stellar-v4.0.0-windows
            executable_ext: .exe
          - os: ubuntu-latest  
            artifact_name: dawn-of-stellar-v4.0.0-linux
            executable_ext: ""
          - os: macos-latest
            artifact_name: dawn-of-stellar-v4.0.0-macos
            executable_ext: ""
    
    steps:
    - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ðŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ ë¹Œë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install pygame colorama websockets qrcode[pil]
        
    - name: ðŸ› ï¸ ë©”ì¸ ê²Œìž„ ë¹Œë“œ
      run: |
        echo "ðŸ› ï¸ Dawn of Stellar v4.0.0 ë¹Œë“œ ì‹œìž‘..."
        pyinstaller --onefile --console \
          --name "dawn-of-stellar-v4.0.0" \
          --icon=assets/icon.ico \
          --add-data "assets/*:assets/" \
          --add-data "game/*:game/" \
          --add-data "sounds/*:sounds/" \
          main.py
        
    - name: ðŸš€ í†µí•© ëŸ°ì²˜ ë¹Œë“œ  
      run: |
        echo "ðŸš€ í†µí•© ëŸ°ì²˜ ë¹Œë“œ..."
        pyinstaller --onefile --console \
          --name "launcher-v4.0.0" \
          python_launcher.py
          
    - name: ðŸ“± ëª¨ë°”ì¼ ë°±ì—”ë“œ ë¹Œë“œ
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "ðŸ“± ëª¨ë°”ì¼ ë°±ì—”ë“œ ë¹Œë“œ..."
        pyinstaller --onefile --console \
          --name "mobile-backend-v4.0.0" \
          mobile_backend_server.py
          
    - name: ðŸ“¦ ì•„í‹°íŒ©íŠ¸ íŒ¨í‚¤ì§•
      run: |
        mkdir -p release
        cp dist/* release/ 2>/dev/null || true
        echo "v4.0.0" > release/VERSION
        echo "Dawn of Stellar v4.0.0 - ì™„ì „ì²´ AI í•™ìŠµ + ë©€í‹°í”Œë ˆì´ì–´" > release/RELEASE_INFO.txt
        
    - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact_name }}
        path: release/

  # ðŸ“± Flutter ëª¨ë°”ì¼ ë¹Œë“œ
  build_mobile:
    name: ðŸ“± Flutter ëª¨ë°”ì¼ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ðŸ“± Flutter ì„¤ì •
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        
    - name: ðŸ“¦ Flutter ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./mobile_client
      run: |
        flutter pub get
        
    - name: ðŸ”¨ Android APK ë¹Œë“œ
      working-directory: ./mobile_client
      run: |
        flutter build apk --release
        
    - name: ðŸ“¤ APK ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: dawn-of-stellar-v4.0.0-android
        path: mobile_client/build/app/outputs/flutter-apk/app-release.apk

  # ðŸŽ‰ ë¦´ë¦¬ì¦ˆ ìƒì„±
  release:
    name: ðŸŽ‰ GitHub ë¦´ë¦¬ì¦ˆ ìƒì„±
    runs-on: ubuntu-latest
    needs: [build, build_mobile]
    if: startsWith(github.ref, 'refs/tags/v4.')
    
    steps:
    - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ ëª¨ë“  ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v3
      
    - name: ðŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
      run: |
        cat > release_notes.md << 'EOF'
        # ðŸš€ Dawn of Stellar v4.0.0 - ì™„ì „ì²´ ë¦´ë¦¬ì¦ˆ!
        
        ## ðŸŽ® ì„¸ê³„ ìµœì´ˆ AI í•™ìŠµ ë©€í‹°í”Œë ˆì´ì–´ ë¡œê·¸ë¼ì´í¬!
        
        ### ðŸ¤– í˜ì‹ ì ì¸ AI í•™ìŠµ ì‹œìŠ¤í…œ
        - **ì˜êµ¬ AI í•™ìŠµ**: ì»´í“¨í„° ìž¬ì‹œìž‘í•´ë„ í•™ìŠµ ë°ì´í„° ìœ ì§€
        - **28ê°œ ì§ì—… íŠ¹í™”**: ê° ì§ì—…ë§ˆë‹¤ 64ê°œ ìŠ¤í‚¬ + 64ê°œ ì „ëžµ
        - **ë°¤ìƒˆ ìžë™ í•™ìŠµ**: 8ì‹œê°„ ë¬´ì¸ í•™ìŠµìœ¼ë¡œ AI ì²œìž¬ ë§Œë“¤ê¸°
        - **AI ì§„í™” ì‹œìŠ¤í…œ**: 6ë‹¨ê³„ ì§€ëŠ¥ ë ˆë²¨ ì§„í™”
        - **AI í† ë„ˆë¨¼íŠ¸**: AIë“¤ë¼ë¦¬ ëŒ€ì „í•˜ë©° ìƒí˜¸ í•™ìŠµ
        
        ### ðŸŒ ì™„ì „í•œ ë„¤íŠ¸ì›Œí¬ ë©€í‹°í”Œë ˆì´ì–´
        - **WebSocket ê¸°ë°˜**: ì•ˆì •ì ì¸ ì‹¤ì‹œê°„ í†µì‹ 
        - **í¬ë¡œìŠ¤ í”Œëž«í¼**: PC + ëª¨ë°”ì¼ + ì›¹ ë¸Œë¼ìš°ì €
        - **QR ì½”ë“œ ì—°ê²°**: ëª¨ë°”ì¼ì—ì„œ ê°„íŽ¸ ì ‘ì†
        - **ì‹¤ì‹œê°„ ì±„íŒ…**: í”Œë ˆì´ì–´ ê°„ ì†Œí†µ
        
        ### ðŸ“± Flutter ëª¨ë°”ì¼ í´ë¼ì´ì–¸íŠ¸
        - **í„°ë¯¸ë„ ìŠ¤íƒ€ì¼**: ë ˆíŠ¸ë¡œ ASCII ê°ì„±ì„ ëª¨ë°”ì¼ë¡œ
        - **ì œìŠ¤ì²˜ ì»¨íŠ¸ë¡¤**: ìŠ¤ì™€ì´í”„ ì´ë™, íƒ­ ì•¡ì…˜
        - **ì‹¤ì‹œê°„ ë™ê¸°í™”**: PC-ëª¨ë°”ì¼ ì™„ë²½ ì—°ë™
        
        ## ðŸ“¦ ë‹¤ìš´ë¡œë“œ
        
        ### ðŸ–¥ï¸ PC ë²„ì „
        - **Windows**: `dawn-of-stellar-v4.0.0-windows.zip`
        - **Linux**: `dawn-of-stellar-v4.0.0-linux.zip`  
        - **macOS**: `dawn-of-stellar-v4.0.0-macos.zip`
        
        ### ðŸ“± ëª¨ë°”ì¼ ë²„ì „
        - **Android**: `dawn-of-stellar-v4.0.0-android.apk`
        
        ## ðŸš€ ë¹ ë¥¸ ì‹œìž‘
        
        1. **PC**: ì••ì¶• í•´ì œ â†’ `launcher-v4.0.0.exe` ì‹¤í–‰
        2. **ëª¨ë°”ì¼**: APK ì„¤ì¹˜ â†’ ì•± ì‹¤í–‰
        3. **AI í•™ìŠµ**: ë©”ë‰´ì—ì„œ "ðŸ¤– AI í•™ìŠµ ì‹œìŠ¤í…œ" ì„ íƒ
        4. **ë©€í‹°í”Œë ˆì´ì–´**: "ðŸŒ ë©€í‹°í”Œë ˆì´ì–´ ì„œë²„" ì„ íƒ
        
        ## ðŸŽ¯ ì£¼ìš” íŠ¹ì§•
        
        - âœ… **ì™„ì „ ë¬´ë£Œ**: ì˜¤í”ˆì†ŒìŠ¤ MIT ë¼ì´ì„ ìŠ¤
        - âœ… **í¬ë¡œìŠ¤ í”Œëž«í¼**: Windows, Linux, macOS, Android
        - âœ… **AI í•™ìŠµ**: ì˜êµ¬ í•™ìŠµí•˜ëŠ” ë˜‘ë˜‘í•œ AI
        - âœ… **ë©€í‹°í”Œë ˆì´ì–´**: ì‹¤ì‹œê°„ ë„¤íŠ¸ì›Œí¬ í”Œë ˆì´
        - âœ… **28ê°œ ì§ì—…**: ë‹¤ì–‘í•œ í”Œë ˆì´ ìŠ¤íƒ€ì¼
        - âœ… **ëª¨ë°”ì¼ ì§€ì›**: Flutter ë„¤ì´í‹°ë¸Œ ì•±
        
        ì¦ê±°ìš´ ê²Œìž„ ë˜ì„¸ìš”! ðŸŽ®âœ¨
        EOF
        
    - name: ðŸŽ‰ GitHub ë¦´ë¦¬ì¦ˆ ìƒì„±
      uses: softprops/action-gh-release@v1
      with:
        name: "ðŸš€ Dawn of Stellar v4.0.0 - ì™„ì „ì²´!"
        body_path: release_notes.md
        files: |
          dawn-of-stellar-v4.0.0-windows/**/*
          dawn-of-stellar-v4.0.0-linux/**/*
          dawn-of-stellar-v4.0.0-macos/**/*
          dawn-of-stellar-v4.0.0-android/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ðŸŽ¯ ë°°í¬ í›„ í…ŒìŠ¤íŠ¸
  post_release_test:
    name: ðŸŽ¯ ë¦´ë¦¬ì¦ˆ í›„ ê²€ì¦
    runs-on: ubuntu-latest
    needs: release
    if: startsWith(github.ref, 'refs/tags/v4.')
    
    steps:
    - name: ðŸŽ‰ ë¦´ë¦¬ì¦ˆ ì„±ê³µ ì•Œë¦¼
      run: |
        echo "ðŸŽ‰ Dawn of Stellar v4.0.0 ë¦´ë¦¬ì¦ˆ ì„±ê³µ!"
        echo "ðŸ¤– AI í•™ìŠµ ì‹œìŠ¤í…œ í¬í•¨"
        echo "ðŸŒ ë„¤íŠ¸ì›Œí¬ ë©€í‹°í”Œë ˆì´ì–´ í¬í•¨"  
        echo "ðŸ“± Flutter ëª¨ë°”ì¼ í´ë¼ì´ì–¸íŠ¸ í¬í•¨"
        echo "âœ¨ ì„¸ê³„ ìµœì´ˆ ì™„ì „ì²´ ë¡œê·¸ë¼ì´í¬ ê²Œìž„!"
