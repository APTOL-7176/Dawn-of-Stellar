name: Build and Release Executables

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v2.1.3 ë“±ì˜ íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            executable_name: Dawn-of-Stellar.exe
            artifact_name: Dawn-of-Stellar-Windows
            build_options: "--onefile --console --name=Dawn-of-Stellar"
          - os: ubuntu-latest
            executable_name: Dawn-of-Stellar
            artifact_name: Dawn-of-Stellar-Linux
            build_options: "--onefile --console --name=Dawn-of-Stellar"
          - os: macos-latest
            executable_name: Dawn-of-Stellar
            artifact_name: Dawn-of-Stellar-macOS
            build_options: "--onefile --console --name=Dawn-of-Stellar"

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Create sounds directory (for audio system)
      run: |
        mkdir -p sounds/bgm sounds/sfx
      shell: bash

    - name: Build with PyInstaller
      run: |
        pyinstaller ${{ matrix.build_options }} main.py
      shell: bash

    - name: Prepare release files
      shell: bash
      run: |
        mkdir release_package
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          cp dist/Dawn-of-Stellar.exe release_package/
        else
          cp dist/Dawn-of-Stellar release_package/
        fi
        cp README.md release_package/
        cp requirements.txt release_package/
        if [ -f "SOUND_FIX_GUIDE.md" ]; then
          cp SOUND_FIX_GUIDE.md release_package/
        fi
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          cp "íŒŒì´ì¬_ì„¤ì¹˜.bat" release_package/ 2>/dev/null || true
          cp "ê²Œì„ì‹œì‘_ê°„í¸.bat" release_package/ 2>/dev/null || true
          cp "ë¬¸ì œí•´ê²°.bat" release_package/ 2>/dev/null || true
        fi
        echo "# Dawn Of Stellar - ì‹¤í–‰ ê°€ì´ë“œ" > release_package/ì‹¤í–‰ë°©ë²•.txt
        echo "" >> release_package/ì‹¤í–‰ë°©ë²•.txt
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          echo "Windows: Dawn-of-Stellar.exeë¥¼ ë”ë¸”í´ë¦­í•˜ì„¸ìš”" >> release_package/ì‹¤í–‰ë°©ë²•.txt
        else
          echo "Linux/Mac: í„°ë¯¸ë„ì—ì„œ ./Dawn-of-Stellar ì‹¤í–‰" >> release_package/ì‹¤í–‰ë°©ë²•.txt
        fi
        echo "" >> release_package/ì‹¤í–‰ë°©ë²•.txt
        echo "ğŸµ ì‚¬ìš´ë“œ: ì‚¬ìš´ë“œ íŒŒì¼ ì—†ì–´ë„ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!" >> release_package/ì‹¤í–‰ë°©ë²•.txt
        if [ -f "SOUND_FIX_GUIDE.md" ]; then
          echo "ğŸ“‹ ë¬¸ì œ í•´ê²°: SOUND_FIX_GUIDE.md ì°¸ì¡°" >> release_package/ì‹¤í–‰ë°©ë²•.txt
        else
          echo "ğŸ“‹ ë¬¸ì œ í•´ê²°: GitHub Issuesì—ì„œ ë„ì›€ ìš”ì²­" >> release_package/ì‹¤í–‰ë°©ë²•.txt
        fi

    - name: Create ZIP archive (Windows)
      if: matrix.os == 'windows-latest'
      shell: powershell
      run: |
        cd release_package
        Compress-Archive -Path * -DestinationPath ..\${{ matrix.artifact_name }}.zip

    - name: Create ZIP archive (Linux/Mac)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        cd release_package
        zip -r ../${{ matrix.artifact_name }}.zip *

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_name }}.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          Dawn-of-Stellar-Windows/Dawn-of-Stellar-Windows.zip
          Dawn-of-Stellar-Linux/Dawn-of-Stellar-Linux.zip
          Dawn-of-Stellar-macOS/Dawn-of-Stellar-macOS.zip
        body: |
          ## ğŸ® Dawn Of Stellar - ìƒˆ ë²„ì „ ì¶œì‹œ!
          
          ### ğŸ“¥ ë‹¤ìš´ë¡œë“œ ë°©ë²•
          1. ì•„ë˜ì—ì„œ ìš´ì˜ì²´ì œì— ë§ëŠ” íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          2. ZIP íŒŒì¼ ì••ì¶• í•´ì œ
          3. ì‹¤í–‰ íŒŒì¼ ë”ë¸”í´ë¦­ìœ¼ë¡œ ê²Œì„ ì‹œì‘!
          
          ### ğŸ’» ì§€ì› í”Œë«í¼
          - **Windows**: Dawn-of-Stellar-Windows.zip
          - **Linux**: Dawn-of-Stellar-Linux.zip  
          - **macOS**: Dawn-of-Stellar-macOS.zip
          
          ### âœ… íŠ¹ì§•
          - **Python ì„¤ì¹˜ ë¶ˆí•„ìš”** - ì‹¤í–‰ íŒŒì¼ì— ëª¨ë“  ê²ƒì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤!
          - **ğŸµ ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ ì™„ì „ ê°œì„ ** - ì‚¬ìš´ë“œ íŒŒì¼ ì—†ì–´ë„ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤
          - **ì•ˆì „í•œ ì˜¤ë””ì˜¤ ì²˜ë¦¬** - pygame ì˜¤ë¥˜ ì‹œì—ë„ ê²Œì„ì´ ê³„ì†ë©ë‹ˆë‹¤
          - **ì½˜ì†” ì¶œë ¥ ì§€ì›** - ì˜¤ë¥˜ ë°œìƒ ì‹œ ë©”ì‹œì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
          
          ### ğŸµ ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ ê°œì„ ì‚¬í•­
          - FFVII ìŠ¤íƒ€ì¼ BGM/SFX ì§€ì› (814ê°œ ì‚¬ìš´ë“œ íŒŒì¼)
          - ì‚¬ìš´ë“œ íŒŒì¼ ìë™ íƒì§€ ë° ì•ˆì „í•œ ê²½ë¡œ ì²˜ë¦¬
          - ì‚¬ìš´ë“œ ì—†ì–´ë„ ê²Œì„ ì •ìƒ ì§„í–‰ (DummyAudioManager)
          - ì‹¤í–‰ íŒŒì¼ í¬ë˜ì‹œ ë¬¸ì œ ì™„ì „ í•´ê²°
          
          ### ğŸ”§ ë¬¸ì œ í•´ê²°
          - ì‹¤í–‰ ì‹œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ì½˜ì†” ì°½ì˜ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”
          - Windows Defenderì—ì„œ ì°¨ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì†Œí”„íŠ¸ì›¨ì–´ì…ë‹ˆë‹¤)
          - ë¬¸ì œê°€ ìˆìœ¼ë©´ GitHub Issuesì—ì„œ ë„ì›€ì„ ìš”ì²­í•´ì£¼ì„¸ìš”
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
